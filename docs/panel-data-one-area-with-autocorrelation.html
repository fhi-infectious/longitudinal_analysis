<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Longitudinal Analysis</title>
  <meta name="description" content="A short course in learning which statistical methods should be applied where.">
  <meta name="generator" content="bookdown 0.7 and GitBook 2.6.7">

  <meta property="og:title" content="Longitudinal Analysis" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="A short course in learning which statistical methods should be applied where." />
  <meta name="github-repo" content="raubreywhite/longitudinal_analysis" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Longitudinal Analysis" />
  
  <meta name="twitter:description" content="A short course in learning which statistical methods should be applied where." />
  

<meta name="author" content="Richard White">


<meta name="date" content="2018-05-22">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="panel-data-one-area-without-autocorrelation.html">
<link rel="next" href="not-panel-data-multiple-areas.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="/">Home</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Syllabus</a></li>
<li class="chapter" data-level="2" data-path="reference.html"><a href="reference.html"><i class="fa fa-check"></i><b>2</b> Reference</a><ul>
<li class="chapter" data-level="2.1" data-path="reference.html"><a href="reference.html#scope-of-this-course"><i class="fa fa-check"></i><b>2.1</b> Scope of this course</a></li>
<li class="chapter" data-level="2.2" data-path="reference.html"><a href="reference.html#introduction"><i class="fa fa-check"></i><b>2.2</b> Introduction</a></li>
<li class="chapter" data-level="2.3" data-path="reference.html"><a href="reference.html#method-summary"><i class="fa fa-check"></i><b>2.3</b> Method summary</a><ul>
<li class="chapter" data-level="2.3.1" data-path="reference.html"><a href="reference.html#panel-data-one-geographical-area-no-autocorrelation"><i class="fa fa-check"></i><b>2.3.1</b> Panel data: One geographical area, no autocorrelation</a></li>
<li class="chapter" data-level="2.3.2" data-path="reference.html"><a href="reference.html#panel-data-one-geographical-area-with-autocorrelation"><i class="fa fa-check"></i><b>2.3.2</b> Panel data: One geographical area, with autocorrelation</a></li>
<li class="chapter" data-level="2.3.3" data-path="reference.html"><a href="reference.html#not-panel-data-multiple-geographical-areas"><i class="fa fa-check"></i><b>2.3.3</b> Not panel data: Multiple geographical areas</a></li>
<li class="chapter" data-level="2.3.4" data-path="reference.html"><a href="reference.html#panel-data-multiple-geographical-areas-no-autocorrelation"><i class="fa fa-check"></i><b>2.3.4</b> Panel data: Multiple geographical areas, no autocorrelation</a></li>
<li class="chapter" data-level="2.3.5" data-path="reference.html"><a href="reference.html#panel-data-multiple-geographical-areas-with-autocorrelation"><i class="fa fa-check"></i><b>2.3.5</b> Panel data: Multiple geographical areas, with autocorrelation</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="reference.html"><a href="reference.html#identifying-your-scenario"><i class="fa fa-check"></i><b>2.4</b> Identifying your scenario</a><ul>
<li class="chapter" data-level="2.4.1" data-path="reference.html"><a href="reference.html#step-1-do-you-have-panel-data"><i class="fa fa-check"></i><b>2.4.1</b> Step 1: Do you have panel data?</a></li>
<li class="chapter" data-level="2.4.2" data-path="reference.html"><a href="reference.html#step-2-do-you-have-multiple-geographical-areas"><i class="fa fa-check"></i><b>2.4.2</b> Step 2: Do you have multiple geographical areas?</a></li>
<li class="chapter" data-level="2.4.3" data-path="reference.html"><a href="reference.html#step-3-do-you-have-autocorrelation"><i class="fa fa-check"></i><b>2.4.3</b> Step 3: Do you have autocorrelation?</a></li>
<li class="chapter" data-level="2.4.4" data-path="reference.html"><a href="reference.html#ar1-data"><i class="fa fa-check"></i><b>2.4.4</b> AR(1) data</a></li>
<li class="chapter" data-level="2.4.5" data-path="reference.html"><a href="reference.html#ar2-data"><i class="fa fa-check"></i><b>2.4.5</b> AR(2) data</a></li>
<li class="chapter" data-level="2.4.6" data-path="reference.html"><a href="reference.html#ma1-data"><i class="fa fa-check"></i><b>2.4.6</b> MA(1) data</a></li>
<li class="chapter" data-level="2.4.7" data-path="reference.html"><a href="reference.html#ma2-data"><i class="fa fa-check"></i><b>2.4.7</b> MA(2) data</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="panel-data-one-area-without-autocorrelation.html"><a href="panel-data-one-area-without-autocorrelation.html"><i class="fa fa-check"></i><b>3</b> Panel data: One area without autocorrelation</a><ul>
<li class="chapter" data-level="3.1" data-path="panel-data-one-area-without-autocorrelation.html"><a href="panel-data-one-area-without-autocorrelation.html#aim"><i class="fa fa-check"></i><b>3.1</b> Aim</a></li>
<li class="chapter" data-level="3.2" data-path="panel-data-one-area-without-autocorrelation.html"><a href="panel-data-one-area-without-autocorrelation.html#creating-the-data"><i class="fa fa-check"></i><b>3.2</b> Creating the data</a></li>
<li class="chapter" data-level="3.3" data-path="panel-data-one-area-without-autocorrelation.html"><a href="panel-data-one-area-without-autocorrelation.html#true-data"><i class="fa fa-check"></i><b>3.3</b> True data</a></li>
<li class="chapter" data-level="3.4" data-path="panel-data-one-area-without-autocorrelation.html"><a href="panel-data-one-area-without-autocorrelation.html#investigation"><i class="fa fa-check"></i><b>3.4</b> Investigation</a></li>
<li class="chapter" data-level="3.5" data-path="panel-data-one-area-without-autocorrelation.html"><a href="panel-data-one-area-without-autocorrelation.html#seasonality"><i class="fa fa-check"></i><b>3.5</b> Seasonality</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="panel-data-one-area-with-autocorrelation.html"><a href="panel-data-one-area-with-autocorrelation.html"><i class="fa fa-check"></i><b>4</b> Panel data: One area with autocorrelation</a><ul>
<li class="chapter" data-level="4.1" data-path="panel-data-one-area-with-autocorrelation.html"><a href="panel-data-one-area-with-autocorrelation.html#aim-1"><i class="fa fa-check"></i><b>4.1</b> Aim</a></li>
<li class="chapter" data-level="4.2" data-path="panel-data-one-area-with-autocorrelation.html"><a href="panel-data-one-area-with-autocorrelation.html#creating-the-data-1"><i class="fa fa-check"></i><b>4.2</b> Creating the data</a></li>
<li class="chapter" data-level="4.3" data-path="panel-data-one-area-with-autocorrelation.html"><a href="panel-data-one-area-with-autocorrelation.html#investigation-1"><i class="fa fa-check"></i><b>4.3</b> Investigation</a></li>
<li class="chapter" data-level="4.4" data-path="panel-data-one-area-with-autocorrelation.html"><a href="panel-data-one-area-with-autocorrelation.html#regressions"><i class="fa fa-check"></i><b>4.4</b> Regressions</a></li>
<li class="chapter" data-level="4.5" data-path="panel-data-one-area-with-autocorrelation.html"><a href="panel-data-one-area-with-autocorrelation.html#residual-analysis"><i class="fa fa-check"></i><b>4.5</b> Residual analysis</a></li>
<li class="chapter" data-level="4.6" data-path="panel-data-one-area-with-autocorrelation.html"><a href="panel-data-one-area-with-autocorrelation.html#r-only-regression-with-ar1-correlation-in-residuals"><i class="fa fa-check"></i><b>4.6</b> (R ONLY) Regression with AR(1) correlation in residuals</a></li>
<li class="chapter" data-level="4.7" data-path="panel-data-one-area-with-autocorrelation.html"><a href="panel-data-one-area-with-autocorrelation.html#stata-only-regression-with-robust-standard-errors"><i class="fa fa-check"></i><b>4.7</b> (STATA ONLY) Regression with robust standard errors</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="not-panel-data-multiple-areas.html"><a href="not-panel-data-multiple-areas.html"><i class="fa fa-check"></i><b>5</b> Not panel data: Multiple areas</a><ul>
<li class="chapter" data-level="5.1" data-path="not-panel-data-multiple-areas.html"><a href="not-panel-data-multiple-areas.html#aim-2"><i class="fa fa-check"></i><b>5.1</b> Aim</a></li>
<li class="chapter" data-level="5.2" data-path="not-panel-data-multiple-areas.html"><a href="not-panel-data-multiple-areas.html#creating-the-data-2"><i class="fa fa-check"></i><b>5.2</b> Creating the data</a></li>
<li class="chapter" data-level="5.3" data-path="not-panel-data-multiple-areas.html"><a href="not-panel-data-multiple-areas.html#investigating-the-data"><i class="fa fa-check"></i><b>5.3</b> Investigating the data</a></li>
<li class="chapter" data-level="5.4" data-path="not-panel-data-multiple-areas.html"><a href="not-panel-data-multiple-areas.html#regression"><i class="fa fa-check"></i><b>5.4</b> Regression</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="panel-data-multiple-areas-without-autocorrelation.html"><a href="panel-data-multiple-areas-without-autocorrelation.html"><i class="fa fa-check"></i><b>6</b> Panel data: multiple areas without autocorrelation</a><ul>
<li class="chapter" data-level="6.1" data-path="panel-data-multiple-areas-without-autocorrelation.html"><a href="panel-data-multiple-areas-without-autocorrelation.html#aim-3"><i class="fa fa-check"></i><b>6.1</b> Aim</a></li>
<li class="chapter" data-level="6.2" data-path="panel-data-multiple-areas-without-autocorrelation.html"><a href="panel-data-multiple-areas-without-autocorrelation.html#creating-the-data-3"><i class="fa fa-check"></i><b>6.2</b> Creating the data</a></li>
<li class="chapter" data-level="6.3" data-path="panel-data-multiple-areas-without-autocorrelation.html"><a href="panel-data-multiple-areas-without-autocorrelation.html#investigation-2"><i class="fa fa-check"></i><b>6.3</b> Investigation</a></li>
<li class="chapter" data-level="6.4" data-path="panel-data-multiple-areas-without-autocorrelation.html"><a href="panel-data-multiple-areas-without-autocorrelation.html#regression-1"><i class="fa fa-check"></i><b>6.4</b> Regression</a></li>
<li class="chapter" data-level="6.5" data-path="panel-data-multiple-areas-without-autocorrelation.html"><a href="panel-data-multiple-areas-without-autocorrelation.html#residual-analysis-1"><i class="fa fa-check"></i><b>6.5</b> Residual analysis</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="panel-data-multiple-areas-with-autocorrelation.html"><a href="panel-data-multiple-areas-with-autocorrelation.html"><i class="fa fa-check"></i><b>7</b> Panel data: multiple areas with autocorrelation</a><ul>
<li class="chapter" data-level="7.1" data-path="panel-data-multiple-areas-with-autocorrelation.html"><a href="panel-data-multiple-areas-with-autocorrelation.html#aim-4"><i class="fa fa-check"></i><b>7.1</b> Aim</a></li>
<li class="chapter" data-level="7.2" data-path="panel-data-multiple-areas-with-autocorrelation.html"><a href="panel-data-multiple-areas-with-autocorrelation.html#creating-the-data-4"><i class="fa fa-check"></i><b>7.2</b> Creating the data</a></li>
<li class="chapter" data-level="7.3" data-path="panel-data-multiple-areas-with-autocorrelation.html"><a href="panel-data-multiple-areas-with-autocorrelation.html#investigation-3"><i class="fa fa-check"></i><b>7.3</b> Investigation</a></li>
<li class="chapter" data-level="7.4" data-path="panel-data-multiple-areas-with-autocorrelation.html"><a href="panel-data-multiple-areas-with-autocorrelation.html#regressions-1"><i class="fa fa-check"></i><b>7.4</b> Regressions</a></li>
<li class="chapter" data-level="7.5" data-path="panel-data-multiple-areas-with-autocorrelation.html"><a href="panel-data-multiple-areas-with-autocorrelation.html#residual-analysis-2"><i class="fa fa-check"></i><b>7.5</b> Residual analysis</a></li>
<li class="chapter" data-level="7.6" data-path="panel-data-multiple-areas-with-autocorrelation.html"><a href="panel-data-multiple-areas-with-autocorrelation.html#r-only-regression-with-ar1-correlation-in-residuals-1"><i class="fa fa-check"></i><b>7.6</b> (R ONLY) Regression with AR(1) correlation in residuals</a></li>
<li class="chapter" data-level="7.7" data-path="panel-data-multiple-areas-with-autocorrelation.html"><a href="panel-data-multiple-areas-with-autocorrelation.html#residual-analysis-3"><i class="fa fa-check"></i><b>7.7</b> Residual analysis</a></li>
<li class="chapter" data-level="7.8" data-path="panel-data-multiple-areas-with-autocorrelation.html"><a href="panel-data-multiple-areas-with-autocorrelation.html#stata-only-regression-with-robust-standard-errors-1"><i class="fa fa-check"></i><b>7.8</b> (STATA ONLY) Regression with robust standard errors</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="exercises.html"><a href="exercises.html"><i class="fa fa-check"></i><b>8</b> Exercises</a><ul>
<li class="chapter" data-level="8.1" data-path="exercises.html"><a href="exercises.html#exercise-1"><i class="fa fa-check"></i><b>8.1</b> Exercise 1</a></li>
<li class="chapter" data-level="8.2" data-path="exercises.html"><a href="exercises.html#exercise-2"><i class="fa fa-check"></i><b>8.2</b> Exercise 2</a></li>
<li class="chapter" data-level="8.3" data-path="exercises.html"><a href="exercises.html#exercise-3"><i class="fa fa-check"></i><b>8.3</b> Exercise 3</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="solutions.html"><a href="solutions.html"><i class="fa fa-check"></i><b>9</b> Solutions</a><ul>
<li class="chapter" data-level="9.1" data-path="solutions.html"><a href="solutions.html#exercise-1-1"><i class="fa fa-check"></i><b>9.1</b> Exercise 1</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="solutions-1.html"><a href="solutions-1.html"><i class="fa fa-check"></i><b>10</b> Solutions</a><ul>
<li class="chapter" data-level="10.1" data-path="solutions-1.html"><a href="solutions-1.html#exercise-2-1"><i class="fa fa-check"></i><b>10.1</b> Exercise 2</a></li>
<li class="chapter" data-level="10.2" data-path="solutions-1.html"><a href="solutions-1.html#exercise-3-1"><i class="fa fa-check"></i><b>10.2</b> Exercise 3</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Longitudinal Analysis</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="panel-data-one-area-with-autocorrelation" class="section level1">
<h1><span class="header-section-number">Chapter 4</span> Panel data: One area with autocorrelation</h1>
<div id="aim-1" class="section level2">
<h2><span class="header-section-number">4.1</span> Aim</h2>
<p>We are given a dataset containing daily counts of diseases from one geographical area. We want to identify:</p>
<ul>
<li>Does seasonality exist?</li>
<li>If seasonality exists, when are the high/low seasons?</li>
<li>Is there a general yearly trend (i.e. increasing or decreasing from year to year?)</li>
</ul>
<p>(We remove the question about rainfall in order to simplify and streamline the exercise)</p>

</div>
<div id="creating-the-data-1" class="section level2">
<h2><span class="header-section-number">4.2</span> Creating the data</h2>
<p>The data for this chapter is available at: <a href="http://rwhite.no/longitudinal_analysis/data/chapter_4.csv" class="uri">http://rwhite.no/longitudinal_analysis/data/chapter_4.csv</a></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(data.table)
<span class="kw">library</span>(ggplot2)
<span class="kw">set.seed</span>(<span class="dv">4</span>)

AMPLITUDE &lt;-<span class="st"> </span><span class="fl">1.5</span>
SEASONAL_HORIZONTAL_SHIFT &lt;-<span class="st"> </span><span class="dv">20</span>

d &lt;-<span class="st"> </span><span class="kw">data.table</span>(<span class="dt">date=</span><span class="kw">seq.Date</span>(
  <span class="dt">from=</span><span class="kw">as.Date</span>(<span class="st">&quot;2000-01-01&quot;</span>),
  <span class="dt">to=</span><span class="kw">as.Date</span>(<span class="st">&quot;2018-12-31&quot;</span>),
  <span class="dt">by=</span><span class="dv">1</span>))
d[,year<span class="op">:</span><span class="er">=</span><span class="kw">as.numeric</span>(<span class="kw">format.Date</span>(date,<span class="st">&quot;%G&quot;</span>))]
d[,week<span class="op">:</span><span class="er">=</span><span class="kw">as.numeric</span>(<span class="kw">format.Date</span>(date,<span class="st">&quot;%V&quot;</span>))]
d[,month<span class="op">:</span><span class="er">=</span><span class="kw">as.numeric</span>(<span class="kw">format.Date</span>(date,<span class="st">&quot;%m&quot;</span>))]
d[,yearMinus2000<span class="op">:</span><span class="er">=</span>year<span class="op">-</span><span class="dv">2000</span>]
d[,dayOfSeries<span class="op">:</span><span class="er">=</span><span class="dv">1</span><span class="op">:</span>.N]

d[,dayOfYear<span class="op">:</span><span class="er">=</span><span class="kw">as.numeric</span>(<span class="kw">format.Date</span>(date,<span class="st">&quot;%j&quot;</span>))]
d[,seasonalEffect<span class="op">:</span><span class="er">=</span><span class="kw">sin</span>(<span class="dv">2</span><span class="op">*</span>pi<span class="op">*</span>(dayOfYear<span class="op">-</span>SEASONAL_HORIZONTAL_SHIFT)<span class="op">/</span><span class="dv">365</span>)]
d[,mu <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">exp</span>(<span class="fl">0.1</span> <span class="op">+</span><span class="st"> </span>yearMinus2000<span class="op">*</span><span class="fl">0.1</span> <span class="op">+</span><span class="st"> </span>seasonalEffect<span class="op">*</span>AMPLITUDE)]
d[,y<span class="op">:</span><span class="er">=</span><span class="kw">rpois</span>(.N,mu)]
d[,y<span class="op">:</span><span class="er">=</span><span class="kw">round</span>(<span class="kw">as.numeric</span>(<span class="kw">arima.sim</span>(<span class="dt">model=</span><span class="kw">list</span>(<span class="st">&quot;ar&quot;</span>=<span class="kw">c</span>(<span class="fl">0.5</span>)), <span class="dt">rand.gen =</span> rpois, <span class="dt">n=</span><span class="kw">nrow</span>(d), <span class="dt">lambda=</span>mu)))]

<span class="kw">fwrite</span>(d,<span class="st">&quot;data/chapter_4.csv&quot;</span>)</code></pre></div>

</div>
<div id="investigation-1" class="section level2">
<h2><span class="header-section-number">4.3</span> Investigation</h2>
<p>We display the data for few years and see a clear seasonal trend</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">q &lt;-<span class="st"> </span><span class="kw">ggplot</span>(d[year <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="dv">2005</span><span class="op">:</span><span class="dv">2010</span>)],<span class="kw">aes</span>(<span class="dt">x=</span>dayOfYear,<span class="dt">y=</span>y))
q &lt;-<span class="st"> </span>q <span class="op">+</span><span class="st"> </span><span class="kw">facet_wrap</span>(<span class="op">~</span>year)
q &lt;-<span class="st"> </span>q <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>()
q &lt;-<span class="st"> </span>q <span class="op">+</span><span class="st"> </span><span class="kw">stat_smooth</span>(<span class="dt">colour=</span><span class="st">&quot;red&quot;</span>)
q</code></pre></div>
<pre><code>## `geom_smooth()` using method = &#39;loess&#39;</code></pre>
<p><img src="longitudinal-analysis_files/figure-html/unnamed-chunk-29-1.png" width="672" /></p>

<p>The Lomb-Scargle Periodogram shows a clear seasonality with a period of 365 days</p>
<pre><code>// STATA CODE STARTS
insheet using &quot;chapter_4.csv&quot;, clear

sort date
gen time=_n
tsset time, daily

wntestb y

cumsp y, gen(cumulative_spec_dist)
gen period=_N/_n

browse cumulative_spec_dist period
// STATA CODE ENDS</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># R CODE</span>
lomb<span class="op">::</span><span class="kw">lsp</span>(d<span class="op">$</span>y,<span class="dt">from=</span><span class="dv">50</span>,<span class="dt">to=</span><span class="dv">500</span>,<span class="dt">ofac=</span><span class="dv">1</span>,<span class="dt">type=</span><span class="st">&quot;period&quot;</span>)</code></pre></div>
<p><img src="longitudinal-analysis_files/figure-html/unnamed-chunk-30-1.png" width="672" /></p>

</div>
<div id="regressions" class="section level2">
<h2><span class="header-section-number">4.4</span> Regressions</h2>
<p>We then generate two new variables <code>cos365</code> and <code>sin365</code> and perform a likelihood ratio test to see if they are significant or not. This is done with two simple poisson regressions.</p>
<pre><code>// STATA CODE STARTS
gen cos365=cos(dayofyear*2*_pi/365)
gen sin365=sin(dayofyear*2*_pi/365)

glm y yearminus2000, family(poisson)
estimates store m1
glm y yearminus2000 cos365 sin365, family(poisson)
estimates store m2

predict resid, anscombe

lrtest m1 m2
// STATA CODE ENDS</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># R CODE</span>
d[,cos365<span class="op">:</span><span class="er">=</span><span class="kw">cos</span>(dayOfYear<span class="op">*</span><span class="dv">2</span><span class="op">*</span>pi<span class="op">/</span><span class="dv">365</span>)]
d[,sin365<span class="op">:</span><span class="er">=</span><span class="kw">sin</span>(dayOfYear<span class="op">*</span><span class="dv">2</span><span class="op">*</span>pi<span class="op">/</span><span class="dv">365</span>)]

fit0 &lt;-<span class="st"> </span><span class="kw">glm</span>(y<span class="op">~</span>yearMinus2000, <span class="dt">data=</span>d, <span class="dt">family=</span><span class="kw">poisson</span>())
fit1 &lt;-<span class="st"> </span><span class="kw">glm</span>(y<span class="op">~</span>yearMinus2000<span class="op">+</span>sin365 <span class="op">+</span><span class="st"> </span>cos365, <span class="dt">data=</span>d, <span class="dt">family=</span><span class="kw">poisson</span>())

<span class="kw">print</span>(lmtest<span class="op">::</span><span class="kw">lrtest</span>(fit0, fit1))</code></pre></div>
<pre><code>## Likelihood ratio test
## 
## Model 1: y ~ yearMinus2000
## Model 2: y ~ yearMinus2000 + sin365 + cos365
##   #Df LogLik Df Chisq Pr(&gt;Chisq)    
## 1   2 -43124                        
## 2   4 -14542  2 57163  &lt; 2.2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<p>We see that the likelihood ratio test for <code>sin365</code> and <code>cos365</code> was significant, meaning that there is significant seasonality with a 365 day periodicity in our data (which we already strongly suspected due to the periodogram).</p>

<p>We can now run/look at the results of our main regression.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">print</span>(<span class="kw">summary</span>(fit1))</code></pre></div>
<pre><code>## 
## Call:
## glm(formula = y ~ yearMinus2000 + sin365 + cos365, family = poisson(), 
##     data = d)
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -2.6774  -0.6738  -0.0503   0.4920   3.5820  
## 
## Coefficients:
##                 Estimate Std. Error z value Pr(&gt;|z|)    
## (Intercept)    0.7981246  0.0105300   75.80   &lt;2e-16 ***
## yearMinus2000  0.0991480  0.0007416  133.70   &lt;2e-16 ***
## sin365         1.4074818  0.0073418  191.71   &lt;2e-16 ***
## cos365        -0.5390314  0.0061513  -87.63   &lt;2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for poisson family taken to be 1)
## 
##     Null deviance: 81832.6  on 6939  degrees of freedom
## Residual deviance:  5217.8  on 6936  degrees of freedom
## AIC: 29093
## 
## Number of Fisher Scoring iterations: 4</code></pre>
<p>We also see that the coefficient for year is <code>0.1</code> which means that for each additional year, the outcome increases by <code>exp(0.1)=1.11</code>.</p>

</div>
<div id="residual-analysis" class="section level2">
<h2><span class="header-section-number">4.5</span> Residual analysis</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">d[,residuals<span class="op">:</span><span class="er">=</span><span class="kw">residuals</span>(fit1, <span class="dt">type =</span> <span class="st">&quot;response&quot;</span>)]
d[,predicted<span class="op">:</span><span class="er">=</span><span class="kw">predict</span>(fit1, <span class="dt">type =</span> <span class="st">&quot;response&quot;</span>)]</code></pre></div>
<p>We can see a clear <code>AR(1)</code> pattern in our residuals.</p>
<pre><code>// STATA CODE STARTS
pac resid
// STATA CODE ENDS</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># R CODE</span>
<span class="co"># this is for AR</span>
<span class="kw">pacf</span>(d<span class="op">$</span>residuals)</code></pre></div>
<p><img src="longitudinal-analysis_files/figure-html/unnamed-chunk-34-1.png" width="672" /></p>

<p>And again we see some sort of <code>AR</code> pattern in our residuals.</p>
<pre><code>// STATA CODE STARTS
ac resid
// STATA CODE ENDS</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># R CODE</span>
<span class="co"># this is for MA</span>
<span class="kw">acf</span>(d<span class="op">$</span>residuals)</code></pre></div>
<p><img src="longitudinal-analysis_files/figure-html/unnamed-chunk-35-1.png" width="672" /></p>
<p>This means our model is bad, we have autocorrelation. We now need to change our model to account for this <code>AR(1)</code> autocorrelation!</p>

</div>
<div id="r-only-regression-with-ar1-correlation-in-residuals" class="section level2">
<h2><span class="header-section-number">4.6</span> (R ONLY) Regression with AR(1) correlation in residuals</h2>
<p>First we create an <code>id</code> variable. This generally corresponds to geographical locations, or people. In this case, we only have one geographical location, so our <code>id</code> for all observations is <code>1</code>. This lets the computer know that all data belongs to the same group.</p>
<p>When we have autocorrelation in the residuals, we can use the <code>MASS::glmPQL</code> function in R.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">d[,ID<span class="op">:</span><span class="er">=</span><span class="dv">1</span>]
<span class="co"># this is for MA</span>
fit &lt;-<span class="st"> </span>MASS<span class="op">::</span><span class="kw">glmmPQL</span>(y<span class="op">~</span>yearMinus2000<span class="op">+</span>sin365 <span class="op">+</span><span class="st"> </span>cos365, <span class="dt">random =</span> <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">|</span><span class="st"> </span>ID,
                <span class="dt">family =</span> poisson, <span class="dt">data =</span> d,
                <span class="dt">correlation=</span>nlme<span class="op">::</span><span class="kw">corAR1</span>(<span class="dt">form=</span><span class="op">~</span>dayOfSeries<span class="op">|</span>ID))</code></pre></div>
<pre><code>## iteration 1</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(fit)</code></pre></div>
<pre><code>## Linear mixed-effects model fit by maximum likelihood
##  Data: d 
##   AIC BIC logLik
##    NA  NA     NA
## 
## Random effects:
##  Formula: ~1 | ID
##          (Intercept) Residual
## StdDev: 1.149069e-05 0.841689
## 
## Correlation Structure: AR(1)
##  Formula: ~dayOfSeries | ID 
##  Parameter estimate(s):
##       Phi 
## 0.4926123 
## Variance function:
##  Structure: fixed weights
##  Formula: ~invwt 
## Fixed effects: y ~ yearMinus2000 + sin365 + cos365 
##                    Value   Std.Error   DF   t-value p-value
## (Intercept)    0.7980540 0.015203158 6936  52.49265       0
## yearMinus2000  0.0991582 0.001070583 6936  92.62077       0
## sin365         1.4074339 0.010596649 6936 132.81876       0
## cos365        -0.5389807 0.008876447 6936 -60.72031       0
##  Correlation: 
##               (Intr) yM2000 sin365
## yearMinus2000 -0.832              
## sin365        -0.409  0.000       
## cos365         0.186  0.000 -0.158
## 
## Standardized Within-Group Residuals:
##         Min          Q1         Med          Q3         Max 
## -2.89886753 -0.75775062 -0.05982255  0.60730690  6.49964494 
## 
## Number of Observations: 6940
## Number of Groups: 1</code></pre>

<p>We can see that the residuals no longer display any signs of autocorrelation.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">pacf</span>(<span class="kw">residuals</span>(fit, <span class="dt">type =</span> <span class="st">&quot;normalized&quot;</span>)) <span class="co"># this is for AR</span></code></pre></div>
<p><img src="longitudinal-analysis_files/figure-html/unnamed-chunk-37-1.png" width="672" /></p>

<p>We can see that the residuals no longer display any signs of autocorrelation.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">acf</span>(<span class="kw">residuals</span>(fit, <span class="dt">type =</span> <span class="st">&quot;normalized&quot;</span>)) <span class="co"># this is for MA</span></code></pre></div>
<p><img src="longitudinal-analysis_files/figure-html/unnamed-chunk-38-1.png" width="672" /></p>

<p>We also obtain the same estimates that we did in the last chapter.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">b1 &lt;-<span class="st"> </span><span class="fl">1.3936185</span> <span class="co"># sin coefficient</span>
b2 &lt;-<span class="st"> </span><span class="op">-</span><span class="fl">0.5233866</span> <span class="co"># cos coefficient</span>
amplitude &lt;-<span class="st"> </span><span class="kw">sqrt</span>(b1<span class="op">^</span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span>b2<span class="op">^</span><span class="dv">2</span>)
p &lt;-<span class="st"> </span><span class="kw">atan</span>(b1<span class="op">/</span>b2) <span class="op">*</span><span class="st"> </span><span class="dv">365</span><span class="op">/</span><span class="dv">2</span><span class="op">/</span>pi
<span class="cf">if</span> (p <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) {
    peak &lt;-<span class="st"> </span>p
    trough &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="dv">365</span><span class="op">/</span><span class="dv">2</span>
} <span class="cf">else</span> {
    peak &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="dv">365</span><span class="op">/</span><span class="dv">2</span>
    trough &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="dv">365</span>
}
<span class="cf">if</span> (b1 <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>) {
    g &lt;-<span class="st"> </span>peak
    peak &lt;-<span class="st"> </span>trough
    trough &lt;-<span class="st"> </span>g
}
<span class="kw">print</span>(<span class="kw">sprintf</span>(<span class="st">&quot;amplitude is estimated as %s, peak is estimated as %s, trough is estimated as %s&quot;</span>,<span class="kw">round</span>(amplitude,<span class="dv">2</span>),<span class="kw">round</span>(peak),<span class="kw">round</span>(trough)))</code></pre></div>
<pre><code>## [1] &quot;amplitude is estimated as 1.49, peak is estimated as 112, trough is estimated as 295&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">print</span>(<span class="kw">sprintf</span>(<span class="st">&quot;true values are: amplitude: %s, peak: %s, trough: %s&quot;</span>,<span class="kw">round</span>(AMPLITUDE,<span class="dv">2</span>),<span class="kw">round</span>(<span class="dv">365</span><span class="op">/</span><span class="dv">4</span><span class="op">+</span>SEASONAL_HORIZONTAL_SHIFT),<span class="kw">round</span>(<span class="dv">3</span><span class="op">*</span><span class="dv">365</span><span class="op">/</span><span class="dv">4</span><span class="op">+</span>SEASONAL_HORIZONTAL_SHIFT)))</code></pre></div>
<pre><code>## [1] &quot;true values are: amplitude: 1.5, peak: 111, trough: 294&quot;</code></pre>

</div>
<div id="stata-only-regression-with-robust-standard-errors" class="section level2">
<h2><span class="header-section-number">4.7</span> (STATA ONLY) Regression with robust standard errors</h2>
<p>In STATA it is not possible to explicitly model autocorrelation in the residuals (with the exception of linear regression). Since most of our work deals with logistic and poisson regressions, we will be focusing on modelling strategies that work with all kinds of regressions.</p>
<p>The STATA approach to autocorrelation is to estimate more <code>robust</code> standard errors. That is, STATA makes the standard errors larger to account for the model mispecification. This is done through the <code>vce(robust)</code> option.</p>
<pre><code>// STATA CODE STARTS
glm y yearminus2000 cos365 sin365, family(poisson) vce(robust)
// STATA CODE ENDS</code></pre>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="panel-data-one-area-without-autocorrelation.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="not-panel-data-multiple-areas.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/raubreywhite/longitudinal_analysis/edit/master/03-one-area-with-autocorrelation.Rmd",
"text": "Edit"
},
"download": ["longitudinal-analysis.pdf"],
"toc": {
"collapse": "subsection",
"scroll_highlight": true
},
"search": true
});
});
</script>

</body>

</html>
